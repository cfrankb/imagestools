import json

DEST_PATH = "/home/cfrankb/toolkit/gcc/cs3-runtime-sdl/src/"

HEADER = """
#pragma once

#include <cstdint>

struct layerdata_t {
    uint8_t nextTile;
    uint8_t animeSpeed;
    uint8_t tileType;
    uint8_t weight;
    const char *tag;
};

enum LayerTileType {
    Background,
    Foreground,
    Solid,
    Deadly,
    Water,
};

extern layerdata_t g_layerdata[256];

constexpr inline const layerdata_t & getLayerTileDef(int i) {
    return g_layerdata[i];
}
""".strip()


with open("data/layer0.json") as sfile:
    data = json.load(sfile)


rows = []
tiledata = []

for tile in data["tiles"]:

    if tile["tag"]:
        print(tile)

    row = [
        # str(tile["index"]),
        "0" if tile["next"] < 0 else str(tile["next"]),
        str(tile["speed"]),
        str(tile["type"]),
        str(tile["w"]),
        tile["tag"],
    ]
    rows.append("\t".join(row).strip())

    row = [
        # str(tile["index"]),
        "0" if tile["next"] < 0 else str(tile["next"]),
        str(tile["speed"]),
        str(tile["type"]),
        str(tile["w"]),
        "nullptr" if not tile["tag"] else f'"{tile["tag"]}"',
    ]

    tiledef = "{" + (",".join(row)) + "},\n"
    tiledata.append(tiledef)

with open("out/layerdata.tsv", "w") as t:
    t.write("\n".join(rows))

with open("out/layerdata.h", "w") as t:
    t.write(HEADER + "\n")

with open("out/layerdata.cpp", "w") as t:

    fdata = f"{' '*4}".join(tiledata).strip()
    print(fdata)

    lines = [
        """
// autogenerated

#include "layerdata.h"

layerdata_t g_layerdata[] = {
    {fdata}
};
""".replace(
            "{fdata}", fdata
        ).strip()
    ]

    t.write("\n".join(lines))
